build:
  web:
    privileged: true
    image: docker:1.11
    environment:
      - DOCKER_HOST=tcp://127.0.0.1:2375
    commands:
      - cd web
      - docker build -t web:latest .
      - docker save -o devops-web-latest.tar web:latest

deploy:
  web-test:
    privileged: true
    image: docker:1.11
    environment:
      - DOCKER_HOST=tcp://127.0.0.1:2375
    commands:
      - pwd
      - ls -lha

  sftp:
    host: ip-10-0-2-10.eu-west-1.compute.internal
    port: 22
    username: ubuntu
    destination_path: /home/ubuntu/
    files:
      - web/devops-web-latest.tar

  ssh:
    host: ip-10-0-2-10.eu-west-1.compute.internal
    port: 22
    user: ubuntu
    commands:
      - sudo docker load --input /home/ubuntu/devops-web-latest.tar
      - sudo docker stop web-default
      - sudo docker rm -v web-default
      - sudo docker run -d --name web-default -p 3000:3000 -e PORT=3000 web:latest

compose:
  dind:
    image: docker:1.11-dind
    privileged: true
    command:
      - "-s"
      - "vfs"
